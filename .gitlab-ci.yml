stages:
  - lint
  - test
  - build
  - security
  - deploy

variables:
  IMAGE: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG

lint:
  stage: lint
  script:
    - cd backend && npm ci && npm run lint
    - cd frontend && npm ci && npm run lint
  only:
    - merge_requests

test:
  stage: test
  script:
    - cd backend && npm ci && npm test
    - cd frontend && npm ci && npm test
  only:
    - merge_requests

build:
  stage: build
  script:
    - docker build -t $IMAGE-backend:latest backend/
    - docker build -t $IMAGE-frontend:latest frontend/
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker push $IMAGE-backend:latest
    - docker push $IMAGE-frontend:latest
  only:
    - main

sast:
  stage: security
  script:
    - echo "SAST scan placeholder (use GitLab SAST template)"
  artifacts:
    reports:
      sast: sast-report.json

deploy:
  stage: deploy
  script:
    - bash infra/deploy.sh $CI_ENVIRONMENT_SLUG $IMAGE-backend:latest $IMAGE-frontend:latest
  environment:
    name: production
    url: https://your-production-url.example
  when: manual
  only:
    - main
